<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Календар змін 2/2 — 3 інженери</title>
  <style>
    :root{
      --text:#e9f0f7;
      --muted:#9ab0c8;
      --line:rgba(255,255,255,.12);

      /* Яскравіші кольори */
      --c1:#4F9DFF; --c1f:rgba(79,157,255,.30);
      --c2:#2EE59D; --c2f:rgba(46,229,157,.26);

      /* Інженер 3 — томатний */
      --c3:#FF3B30; --c3f:rgba(255,59,48,.26);

      --radius:16px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      background: radial-gradient(1100px 700px at 20% 0%, rgba(79,157,255,.14), transparent 60%),
                  radial-gradient(900px 600px at 80% 20%, rgba(46,229,157,.12), transparent 55%),
                  radial-gradient(900px 600px at 80% 80%, rgba(255,59,48,.10), transparent 55%),
                  linear-gradient(180deg,#0b0f14,#070a0f);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }

    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .top{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-bottom:12px}
    h1{font-size:18px;margin:0}
    .sub{font-size:13px;color:var(--muted);line-height:1.35}

    .card{
      background: rgba(18,24,38,.86);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:12px;
      backdrop-filter: blur(10px);
    }

    .grid{display:grid;grid-template-columns: 1fr; gap:12px}
    @media(min-width:860px){ .grid{grid-template-columns: 380px 1fr; align-items:start;} }

    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{
      border:1px solid var(--line);
      background: rgba(0,0,0,.15);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:800;
      display:flex;gap:8px;align-items:center;
      user-select:none;
    }
    .btn:hover{border-color:rgba(255,255,255,.22)}
    .btn.active{outline:2px solid rgba(255,255,255,.18); border-color:rgba(255,255,255,.25)}
    .btn:disabled{opacity:.45; cursor:not-allowed}

    .dot{width:10px;height:10px;border-radius:999px;display:inline-block}

    .nav{display:flex;gap:8px;align-items:center}
    .nav button{padding:10px 12px}

    .month{display:grid;grid-template-columns: repeat(7, 1fr);gap:10px;}
    .dow{font-size:12px;color:var(--muted);text-align:center;padding:6px 0}

    .day{
      border:1px solid var(--line);
      border-radius:14px;
      min-height:86px;
      padding:10px;
      position:relative;
      background: rgba(255,255,255,.03);
      overflow:hidden;
    }
    .day.muted{opacity:.48}

    /* Сьогодні: тільки рамка + жирніше число */
    .day.today{
      border:2px solid rgba(255,255,255,.92);
      background: rgba(255,255,255,.06);
    }
    .day.today .num{
      font-weight:1000;
      font-size:16px;
    }

    .num{font-weight:900;font-size:14px}

    /* Заливка для основного інженера (його робочі дні) */
    .fill{
      position:absolute; inset:0;
      opacity:0;
      pointer-events:none;
    }
    .day.primaryWork .fill{opacity:1}

    /* Полоска зліва для напарника (коли він працює) */
    .mateStripe{
      position:absolute; left:0; top:0; bottom:0; width:6px;
      opacity:0;
      pointer-events:none;
    }
    .day.mateWork .mateStripe{opacity:1}

    /* Кружок для графіка 358/323 */
    .gBadge{
      position:absolute;
      left:10px;
      bottom:10px;
      width:34px;height:34px;
      border-radius:999px;
      display:flex;align-items:center;justify-content:center;
      font-size:12px;font-weight:950;
      border:1px solid rgba(255,255,255,.22);
      background: rgba(0,0,0,.30);
      color: var(--text);
    }

    .hint{font-size:13px;color:var(--muted);line-height:1.35}

    .infoBlock{display:grid;gap:10px;margin-top:12px}
    .infoCard{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
      background:rgba(255,255,255,.03);
    }
    .infoTitle{display:flex;gap:8px;align-items:center;font-weight:950}
    .infoRow{margin-top:6px;font-size:13px}

    .warn{
      display:inline-block;
      margin-left:6px;
      font-size:11px;
      font-weight:900;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.18);
      color: var(--muted);
      vertical-align:middle;
    }
    /* 2 дні — білим */
    .warn.soon{
      color:#0b0f14;
      background:#fff;
      border-color:#fff;
    }
    /* 1 день — янтарним */
    .warn.urgent{
      color:#0b0f14;
      background: rgba(255, 179, 0, .95);
      border-color: rgba(255, 179, 0, .95);
    }
    .urgentText{
      margin-top:8px;
      font-size:12px;
      font-weight:900;
      color:#0b0f14;
      background: rgba(255, 179, 0, .16);
      border: 1px solid rgba(255, 179, 0, .45);
      padding:8px 10px;
      border-radius:12px;
      line-height:1.25;
    }

    .sectionTitle{
      margin-top:12px;
      font-size:12px;
      color:var(--muted);
      font-weight:900;
      letter-spacing:.04em;
      text-transform:uppercase;
    }
  </style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div>
      <h1>Календар змін 2/2 — 3 інженери</h1>
      <div class="sub">Інженер: заливка. Напарник: смуга зліва. Графіки: кружок у даті.</div>
    </div>
    <div class="nav">
      <button class="btn" id="prev">← Місяць</button>
      <button class="btn" id="next">Місяць →</button>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="sectionTitle">Інженер</div>
      <div class="controls" id="primaryBtns"></div>

      <div style="height:10px"></div>

      <div class="controls">
        <button class="btn" id="mateToggle" disabled>Напарник</button>
      </div>
      <div class="controls" id="mateBtns" style="display:none;margin-top:10px"></div>

      <div class="sectionTitle">Графіки</div>
      <div class="controls" id="graphBtns"></div>

      <div class="infoBlock" id="info"></div>

      <div style="height:10px"></div>
      <div class="hint" id="hint">Обери інженера або графік.</div>
    </div>

    <div class="card">
      <div class="sub" id="monthTitle" style="font-size:14px;margin:0 0 10px"></div>
      <div class="month" id="cal"></div>
    </div>
  </div>
</div>

<script>
  // ===== Інженери =====
  const PEOPLE = [
    { id: 1, name: "Інженер 1", color: "var(--c1)", fill: "var(--c1f)" },
    { id: 2, name: "Інженер 2", color: "var(--c2)", fill: "var(--c2f)" },
    { id: 3, name: "Інженер 3", color: "var(--c3)", fill: "var(--c3f)" },
  ];

  // ===== Графіки =====
  const GRAPHS = ["358","323"];

  // Якір: 15–16.01.2026 як у прикладі
  const ANCHOR = new Date(2026, 0, 15);

  // Початкові графіки на старті якоря
  const INITIAL_ASSIGNMENT = { 1: "358", 2: "358", 3: "323" };

  // В кінці кожного 2-денного блоку перемикається один інженер: 2 -> 3 -> 1 -> повтор
  const SWITCH_ORDER = [2, 3, 1];

  // ===== Дати/логіка =====
  function daysBetween(a, b){
    const utcA = Date.UTC(a.getFullYear(), a.getMonth(), a.getDate());
    const utcB = Date.UTC(b.getFullYear(), b.getMonth(), b.getDate());
    return Math.floor((utcB - utcA) / 86400000);
  }
  function addDays(d, n){ return new Date(d.getFullYear(), d.getMonth(), d.getDate() + n); }
  function blockIndexForDate(date){
    const diff = daysBetween(ANCHOR, date);
    return Math.floor(diff / 2);
  }
  function startOfBlock(blockIndex){ return addDays(ANCHOR, blockIndex * 2); }

  // Який графік "активний" в цей 2-денний блок (працює)
  function workingGraphForBlock(blockIndex){ return (blockIndex % 2 === 0) ? "358" : "323"; }
  function toggleGraph(g){ return g === "358" ? "323" : "358"; }

  function assignmentAtBlock(targetBlock){
    let a = { ...INITIAL_ASSIGNMENT };
    if (targetBlock === 0) return a;

    if (targetBlock > 0){
      for (let b = 0; b < targetBlock; b++){
        const sw = SWITCH_ORDER[((b % 3) + 3) % 3];
        a[sw] = toggleGraph(a[sw]);
      }
      return a;
    }

    for (let b = -1; b >= targetBlock; b--){
      const sw = SWITCH_ORDER[(((b % 3) + 3) % 3)];
      a[sw] = toggleGraph(a[sw]);
    }
    return a;
  }

  function graphOnDate(personId, date){
    const bi = blockIndexForDate(date);
    const a = assignmentAtBlock(bi);
    return a[personId];
  }

  function isWorkingOnDate(personId, date){
    const bi = blockIndexForDate(date);
    return graphOnDate(personId, date) === workingGraphForBlock(bi);
  }

  // Наступне перемикання — строго в майбутньому (0 днів не буде)
  function nextSwitchDate(personId, fromDate){
    const currentBlock = blockIndexForDate(fromDate);
    for (let b = currentBlock; b < currentBlock + 2000; b++){
      const sw = SWITCH_ORDER[(((b % 3) + 3) % 3)];
      if (sw === personId){
        const candidate = startOfBlock(b + 1);
        if (daysBetween(fromDate, candidate) > 0) return candidate; // строго > сьогодні
      }
    }
    return null;
  }

  function fmtDateUA(d){
    return d.toLocaleDateString("uk-UA", { day:"2-digit", month:"long", year:"numeric" });
  }
  function fmtMonthUA(d){
    return d.toLocaleDateString("uk-UA", { month:"long", year:"numeric" });
  }

  // ===== UI стан =====
  let shown = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
  let primary = null;
  let mate = null;
  let mateMode = false;

  const selectedGraphs = new Set(); // "358", "323"

  const calEl = document.getElementById("cal");
  const monthTitleEl = document.getElementById("monthTitle");
  const primaryBtnsEl = document.getElementById("primaryBtns");
  const mateToggleEl = document.getElementById("mateToggle");
  const mateBtnsEl = document.getElementById("mateBtns");
  const infoEl = document.getElementById("info");
  const hintEl = document.getElementById("hint");
  const graphBtnsEl = document.getElementById("graphBtns");

  function personById(id){ return PEOPLE.find(p => p.id === id); }

  function setPrimary(id){
    if (primary === id){
      primary = null;
      mate = null;
      mateMode = false;
      mateToggleEl.classList.remove("active");
      mateBtnsEl.style.display = "none";
    } else {
      primary = id;
      if (mate === primary) mate = null;
    }
    renderAll();
  }

  function toggleMateMode(){
    if (!primary) return;
    mateMode = !mateMode;
    if (!mateMode) mate = null;
    renderAll();
  }

  function setMate(id){
    if (!primary) return;
    if (id === primary) return;
    mate = (mate === id) ? null : id;
    renderAll();
  }

  function toggleGraphPick(g){
    if (selectedGraphs.has(g)) selectedGraphs.delete(g);
    else selectedGraphs.add(g);
    renderAll();
  }

  // ===== Render кнопок =====
  function renderPrimaryButtons(){
    primaryBtnsEl.innerHTML = "";
    PEOPLE.forEach(p => {
      const btn = document.createElement("button");
      btn.className = "btn" + (primary === p.id ? " active" : "");
      btn.innerHTML = `<span class="dot" style="background:${p.color}"></span>${p.name}`;
      btn.onclick = () => setPrimary(p.id);
      primaryBtnsEl.appendChild(btn);
    });
  }

  function renderMateUI(){
    mateToggleEl.disabled = !primary;
    mateToggleEl.classList.toggle("active", !!primary && mateMode);

    if (!primary || !mateMode){
      mateBtnsEl.style.display = "none";
      mateBtnsEl.innerHTML = "";
      return;
    }

    mateBtnsEl.style.display = "flex";
    mateBtnsEl.style.gap = "10px";
    mateBtnsEl.style.flexWrap = "wrap";

    mateBtnsEl.innerHTML = "";
    PEOPLE.filter(p => p.id !== primary).forEach(p => {
      const btn = document.createElement("button");
      btn.className = "btn" + (mate === p.id ? " active" : "");
      btn.innerHTML = `<span class="dot" style="background:${p.color}"></span>${p.name}`;
      btn.onclick = () => setMate(p.id);
      mateBtnsEl.appendChild(btn);
    });
  }

  function renderGraphButtons(){
    graphBtnsEl.innerHTML = "";
    GRAPHS.forEach(g => {
      const btn = document.createElement("button");
      btn.className = "btn" + (selectedGraphs.has(g) ? " active" : "");
      btn.textContent = g;
      btn.onclick = () => toggleGraphPick(g);
      graphBtnsEl.appendChild(btn);
    });
  }

  // ===== Інфо (тільки про основного інженера) =====
  function renderInfo(){
    infoEl.innerHTML = "";

    const today = new Date();

    if (!primary){
      if (selectedGraphs.size > 0) hintEl.textContent = "Показано графіки.";
      else hintEl.textContent = "Обери інженера або графік.";
      return;
    }

    hintEl.textContent = mateMode ? "Інженер + напарник." : "Інженер обраний.";

    const p = personById(primary);
    const works = isWorkingOnDate(primary, today);
    const gToday = graphOnDate(primary, today);

    const ns = nextSwitchDate(primary, today);
    const left = ns ? daysBetween(today, ns) : null;

    // 2 дні -> білим, 1 день -> янтарним
    let warnClass = "warn";
    if (left === 2) warnClass = "warn soon";
    if (left === 1) warnClass = "warn urgent";

    const targetGraph = toggleGraph(gToday); // на який переходить

    infoEl.insertAdjacentHTML("beforeend", `
      <div class="infoCard">
        <div class="infoTitle"><span class="dot" style="background:${p.color}"></span>${p.name}</div>
        <div class="infoRow"><b>Сьогодні:</b> ${works ? "працює" : "вихідний"} <span class="${warnClass}">${gToday}</span></div>
        <div class="infoRow"><b>Перехід:</b> ${ns ? fmtDateUA(ns) : "—"} <span class="${warnClass}">${left !== null ? `${left} дн.` : ""}</span></div>
        ${left === 1 ? `
          <div class="urgentText">
            Не забудь написати СЗ на зміну графіка на (${targetGraph}): завтра перехід графіка.
          </div>
        ` : ``}
      </div>
    `);
  }

  // ===== Графік у кружку (незалежно від інженера) =====
  function graphBadgeTextForDay(date){
    if (selectedGraphs.size === 0) return null;
    const bi = blockIndexForDate(date);
    const active = workingGraphForBlock(bi); // який графік працює у цей 2-денний блок
    if (selectedGraphs.has(active)) return active;
    return null;
  }

  // ===== Ячейка =====
  function dayCell(date, muted){
    const el = document.createElement("div");
    el.className = "day" + (muted ? " muted" : "");

    const now = new Date();
    const isToday = date.getFullYear()===now.getFullYear() && date.getMonth()===now.getMonth() && date.getDate()===now.getDate();
    if (isToday) el.classList.add("today");

    // primary заливка только если primary выбран и он работает
    let fillBg = "transparent";
    if (primary && isWorkingOnDate(primary, date)){
      fillBg = personById(primary).fill;
      el.classList.add("primaryWork");
    }

    // mate полоса слева только если mate выбран и работает
    let mateStripeBg = "transparent";
    if (mateMode && mate && isWorkingOnDate(mate, date)){
      mateStripeBg = personById(mate).color;
      el.classList.add("mateWork");
    }

    const gText = graphBadgeTextForDay(date);

    el.innerHTML = `
      <div class="fill" style="background:${fillBg}"></div>
      <div class="mateStripe" style="background:${mateStripeBg}"></div>
      <div class="num">${date.getDate()}</div>
      ${gText ? `<div class="gBadge">${gText}</div>` : ``}
    `;
    return el;
  }

  // ===== Calendar render =====
  function renderCalendar(){
    monthTitleEl.textContent = `Місяць: ${fmtMonthUA(shown)}`;

    calEl.innerHTML = "";
    const dows = ["Пн","Вт","Ср","Чт","Пт","Сб","Нд"];
    dows.forEach(x=>{
      const el = document.createElement("div");
      el.className = "dow";
      el.textContent = x;
      calEl.appendChild(el);
    });

    const y = shown.getFullYear();
    const m = shown.getMonth();
    const first = new Date(y, m, 1);
    const startDow = (first.getDay() + 6) % 7;
    const daysInMonth = new Date(y, m+1, 0).getDate();
    const daysInPrev = new Date(y, m, 0).getDate();

    for(let i=0;i<startDow;i++){
      const d = daysInPrev - startDow + 1 + i;
      calEl.appendChild(dayCell(new Date(y, m-1, d), true));
    }
    for(let d=1; d<=daysInMonth; d++){
      calEl.appendChild(dayCell(new Date(y, m, d), false));
    }
    const totalCells = 7 + startDow + daysInMonth;
    const after = (Math.ceil(totalCells/7)*7) - totalCells;
    for(let i=1;i<=after;i++){
      calEl.appendChild(dayCell(new Date(y, m+1, i), true));
    }
  }

  document.getElementById("prev").onclick = () => {
    shown = new Date(shown.getFullYear(), shown.getMonth()-1, 1);
    renderAll();
  };
  document.getElementById("next").onclick = () => {
    shown = new Date(shown.getFullYear(), shown.getMonth()+1, 1);
    renderAll();
  };

  mateToggleEl.onclick = toggleMateMode;

  function renderAll(){
    renderPrimaryButtons();
    renderMateUI();
    renderGraphButtons();
    renderInfo();
    renderCalendar();
  }

  renderAll();
</script>
</body>
</html>
