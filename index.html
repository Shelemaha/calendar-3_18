<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Календарь смен 2/2 — 3 человека</title>
  <style>
    :root{
      --bg:#0b0f14;
      --card:#121826;
      --muted:#9ab0c8;
      --text:#e9f0f7;
      --line:rgba(255,255,255,.10);
      --w1:#6ea8ff; --w2:#62f0a8; --w3:#ffb45e;
      --todayBorder:#ffffff;
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background: radial-gradient(1200px 700px at 20% 0%, rgba(110,168,255,.14), transparent 60%),
                  radial-gradient(900px 600px at 80% 20%, rgba(98,240,168,.12), transparent 55%),
                  radial-gradient(900px 600px at 80% 80%, rgba(255,180,94,.10), transparent 55%),
                  linear-gradient(180deg,#0b0f14,#070a0f);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .top{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-bottom:12px}
    h1{font-size:18px;margin:0}
    .sub{font-size:13px;color:var(--muted);line-height:1.35}
    .card{
      background: rgba(18,24,38,.85);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:12px;
      backdrop-filter: blur(10px);
    }
    .grid{display:grid;grid-template-columns: 1fr; gap:12px}
    @media(min-width:860px){ .grid{grid-template-columns: 340px 1fr; align-items:start;} }

    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{
      border:1px solid var(--line);
      background: rgba(0,0,0,.15);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:800;
      display:flex;gap:8px;align-items:center;
      user-select:none;
    }
    .btn:hover{border-color:rgba(255,255,255,.22)}
    .btn.active{outline:2px solid rgba(255,255,255,.18); border-color:rgba(255,255,255,.25)}
    .dot{width:10px;height:10px;border-radius:999px;display:inline-block}

    .nav{display:flex;gap:8px;align-items:center}
    .nav button{padding:10px 12px}

    .legend{display:flex;gap:10px;flex-wrap:wrap;font-size:12px;color:var(--muted)}
    .legend span{display:flex;gap:6px;align-items:center}

    .month{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:10px;
    }
    .dow{font-size:12px;color:var(--muted);text-align:center;padding:6px 0}

    .day{
      border:1px solid var(--line);
      border-radius:14px;
      min-height:82px;
      padding:10px;
      position:relative;
      background: rgba(255,255,255,.035);
      overflow:hidden;
    }
    .day.muted{opacity:.48}
    .day.today{
      border:2px solid var(--todayBorder);
      background: rgba(255,255,255,.06);
    }
    .todayTag{
      position:absolute;right:10px;top:10px;
      font-size:10px;font-weight:900;
      letter-spacing:.08em;
      color:#0b0f14;
      background:#fff;
      padding:2px 8px;border-radius:999px;
    }

    .num{font-weight:900;font-size:14px}
    .pairRow{margin-top:10px;display:flex;gap:6px;flex-wrap:wrap;align-items:center}
    .pill{
      padding:3px 10px;border-radius:999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      font-weight:900;
      font-size:12px;
      color: var(--text);
    }
    .pill.muted{opacity:.55}

    /* ЧЁТКАЯ ПОДСВЕТКА рабочего дня выбранного сотрудника */
    .workFocus{
      position:absolute; inset:0;
      opacity:0;
      pointer-events:none;
    }
    .day.work .workFocus{opacity:1}
    .workFocus.w1{ background: linear-gradient(180deg, rgba(110,168,255,.28), rgba(110,168,255,.06)); }
    .workFocus.w2{ background: linear-gradient(180deg, rgba(98,240,168,.26), rgba(98,240,168,.06)); }
    .workFocus.w3{ background: linear-gradient(180deg, rgba(255,180,94,.26), rgba(255,180,94,.06)); }

    .workBorder{
      position:absolute; left:0; top:0; bottom:0; width:5px;
      opacity:0;
    }
    .day.work .workBorder{opacity:1}
    .workBorder.w1{background:var(--w1)}
    .workBorder.w2{background:var(--w2)}
    .workBorder.w3{background:var(--w3)}

    .hint{font-size:13px;color:var(--muted);line-height:1.45}
    .kpi{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:12px}
    .kpi .box{border:1px solid var(--line);border-radius:14px;padding:10px;background:rgba(255,255,255,.03)}
    .kpi .n{font-size:18px;font-weight:950}
    .kpi .t{font-size:12px;color:var(--muted)}
  </style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div>
      <h1>Календарь смен 2/2 — 3 человека</h1>
      <div class="sub">
        Нажми на работника — подсветятся его <b>рабочие</b> дни.
        В каждой ячейке показан его график <b>358/323</b> (видно, когда происходит переход).
        Якорь фиксированный: <b>15-е число выбранного месяца</b> = старт блока “1+2 (358)” на 2 дня.
      </div>
    </div>
    <div class="nav">
      <button class="btn" id="prev">← Месяц</button>
      <button class="btn" id="next">Месяц →</button>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="controls" id="people"></div>

      <div class="kpi" id="kpi"></div>

      <div style="height:12px"></div>
      <div class="legend">
        <span><i class="dot" style="background:var(--w1)"></i> Работник 1</span>
        <span><i class="dot" style="background:var(--w2)"></i> Работник 2</span>
        <span><i class="dot" style="background:var(--w3)"></i> Работник 3</span>
      </div>

      <div style="height:10px"></div>
      <div class="hint" id="todayInfo"></div>
    </div>

    <div class="card">
      <div class="sub" id="monthTitle" style="font-size:14px;margin:0 0 10px"></div>
      <div class="month" id="cal"></div>
    </div>
  </div>
</div>

<script>
  const PEOPLE = [
    { id: 1, name: "Работник 1", colorClass: "w1", cssVar: "--w1" },
    { id: 2, name: "Работник 2", colorClass: "w2", cssVar: "--w2" },
    { id: 3, name: "Работник 3", colorClass: "w3", cssVar: "--w3" },
  ];

  // Пары по 2 дня (блоки): (1+2) -> (2+3) -> (1+3) -> повтор
  const PAIRS = [[1,2],[2,3],[1,3]];

  // 358/323 логика на уровне блоков:
  // anchor-блок (15-16) считается "358 работает" и "323 отдыхает"
  // значит:
  // - если блок чётный: работать => 358, отдыхать => 323
  // - если блок нечётный: работать => 323, отдыхать => 358
  function graphLabel(isWorking, blockIndex){
    const even = (blockIndex % 2 === 0);
    if (isWorking) return even ? "358" : "323";
    return even ? "323" : "358";
  }

  function daysBetween(a, b){
    const utcA = Date.UTC(a.getFullYear(), a.getMonth(), a.getDate());
    const utcB = Date.UTC(b.getFullYear(), b.getMonth(), b.getDate());
    return Math.floor((utcB - utcA) / 86400000);
  }

  function anchorForShownMonth(shown){
    // ЯКОРЬ = 15-е число отображаемого месяца
    return new Date(shown.getFullYear(), shown.getMonth(), 15);
  }

  function blockIndexForDate(date, anchor){
    const diff = daysBetween(anchor, date);
    return Math.floor(diff / 2);
  }

  function pairForDate(date, anchor){
    const block = blockIndexForDate(date, anchor);
    const idx = ((block % 3) + 3) % 3; // чтобы работало и "до" якоря
    return PAIRS[idx];
  }

  function isWorking(personId, date, anchor){
    return pairForDate(date, anchor).includes(personId);
  }

  // ===== UI =====
  const calEl = document.getElementById("cal");
  const peopleEl = document.getElementById("people");
  const monthTitleEl = document.getElementById("monthTitle");
  const kpiEl = document.getElementById("kpi");
  const todayInfoEl = document.getElementById("todayInfo");

  let shown = new Date(); // текущий месяц
  let activePerson = 1;   // для чёткости — один выбранный работник

  function fmtMonthTitle(d){
    return d.toLocaleDateString("ru-RU", { year:"numeric", month:"long" }).replace(" г.", "");
  }

  function renderPeople(){
    peopleEl.innerHTML = "";
    PEOPLE.forEach(p => {
      const btn = document.createElement("button");
      btn.className = "btn" + (activePerson === p.id ? " active" : "");
      btn.innerHTML = `<span class="dot" style="background:var(${p.cssVar})"></span>${p.name}`;
      btn.onclick = () => { activePerson = p.id; renderPeople(); renderCalendar(); };
      peopleEl.appendChild(btn);
    });
  }

  function renderKpi(monthDate){
    const anchor = anchorForShownMonth(monthDate);
    const y = monthDate.getFullYear();
    const m = monthDate.getMonth();
    const daysInMonth = new Date(y, m+1, 0).getDate();

    let workDays = 0;
    for(let d=1; d<=daysInMonth; d++){
      const date = new Date(y,m,d);
      if (isWorking(activePerson, date, anchor)) workDays++;
    }

    // Инфа "сегодня"
    const today = new Date();
    const todayAnchor = anchorForShownMonth(new Date(today.getFullYear(), today.getMonth(), 1));
    const todayPair = pairForDate(today, todayAnchor);
    const todayBlock = blockIndexForDate(today, todayAnchor);
    const todayIsWork = isWorking(activePerson, today, todayAnchor);
    const todayGraph = graphLabel(todayIsWork, todayBlock);

    kpiEl.innerHTML = `
      <div class="box">
        <div class="n">${workDays}</div>
        <div class="t">Рабочих дней в ${fmtMonthTitle(monthDate)} для выбранного</div>
      </div>
      <div class="box">
        <div class="n">${todayGraph}</div>
        <div class="t">Сегодня у выбранного график (358/323)</div>
      </div>
    `;

    todayInfoEl.innerHTML = `Сегодня работает пара: <b>${todayPair.join("+")}</b>. Для выбранного: <b>${todayIsWork ? "работает" : "выходной"}</b>.`;
  }

  function dayCell(date, muted, anchor){
    const el = document.createElement("div");
    el.className = "day" + (muted ? " muted" : "");

    const now = new Date();
    const isToday =
      date.getFullYear()===now.getFullYear() &&
      date.getMonth()===now.getMonth() &&
      date.getDate()===now.getDate();

    if (isToday) el.classList.add("today");

    const pair = pairForDate(date, anchor);
    const block = blockIndexForDate(date, anchor);

    const focusIsWork = isWorking(activePerson, date, anchor);
    const focusGraph = graphLabel(focusIsWork, block);

    if (focusIsWork) el.classList.add("work");

    const p = PEOPLE.find(x=>x.id===activePerson);

    el.innerHTML = `
      <div class="workFocus ${p.colorClass}"></div>
      <div class="workBorder ${p.colorClass}"></div>
      ${isToday ? `<div class="todayTag">СЕГОДНЯ</div>` : ``}
      <div class="num">${date.getDate()}</div>

      <div class="pairRow">
        <span class="pill">${pair.join("+")}</span>
        <span class="pill ${focusIsWork ? "" : "muted"}" style="border-color:rgba(255,255,255,.18)">
          ${focusGraph}${focusIsWork ? "" : " (вых)"}
        </span>
      </div>
    `;
    return el;
  }

  function renderCalendar(){
    const anchor = anchorForShownMonth(shown);
    const y = shown.getFullYear();
    const m = shown.getMonth();

    monthTitleEl.textContent = `Месяц: ${fmtMonthTitle(shown)} (якорь: 15-е)`;

    calEl.innerHTML = "";
    const dows = ["Пн","Вт","Ср","Чт","Пт","Сб","Вс"];
    dows.forEach(x=>{
      const el = document.createElement("div");
      el.className = "dow";
      el.textContent = x;
      calEl.appendChild(el);
    });

    const first = new Date(y, m, 1);
    const startDow = (first.getDay() + 6) % 7; // Пн=0...Вс=6
    const daysInMonth = new Date(y, m+1, 0).getDate();
    const daysInPrev = new Date(y, m, 0).getDate();

    // хвост прошлого месяца
    for(let i=0;i<startDow;i++){
      const d = daysInPrev - startDow + 1 + i;
      const date = new Date(y, m-1, d);
      calEl.appendChild(dayCell(date, true, anchor));
    }
    // текущий месяц
    for(let d=1; d<=daysInMonth; d++){
      const date = new Date(y, m, d);
      calEl.appendChild(dayCell(date, false, anchor));
    }
    // добиваем до полного ряда
    const totalCells = 7 + startDow + daysInMonth; // включая DOW
    const after = (Math.ceil(totalCells/7)*7) - totalCells;
    for(let i=1;i<=after;i++){
      const date = new Date(y, m+1, i);
      calEl.appendChild(dayCell(date, true, anchor));
    }

    renderKpi(shown);
  }

  document.getElementById("prev").onclick = () => {
    shown = new Date(shown.getFullYear(), shown.getMonth()-1, 1);
    renderCalendar();
  };
  document.getElementById("next").onclick = () => {
    shown = new Date(shown.getFullYear(), shown.getMonth()+1, 1);
    renderCalendar();
  };

  renderPeople();
  renderCalendar();
</script>
</body>
</html>
