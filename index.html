<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Календар змін 2/2 — 3 інженери</title>
  <style>
    :root{
      --bg:#0b0f14;
      --card:#121826;
      --muted:#9ab0c8;
      --text:#e9f0f7;
      --line:rgba(255,255,255,.12);

      --c1:#6ea8ff; /* Інженер 1 */
      --c2:#62f0a8; /* Інженер 2 */
      --c3:#ffb45e; /* Інженер 3 */

      --radius:16px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      background: radial-gradient(1100px 700px at 20% 0%, rgba(110,168,255,.14), transparent 60%),
                  radial-gradient(900px 600px at 80% 20%, rgba(98,240,168,.12), transparent 55%),
                  radial-gradient(900px 600px at 80% 80%, rgba(255,180,94,.10), transparent 55%),
                  linear-gradient(180deg,#0b0f14,#070a0f);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .top{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-bottom:12px}
    h1{font-size:18px;margin:0}
    .sub{font-size:13px;color:var(--muted);line-height:1.35}

    .card{
      background: rgba(18,24,38,.86);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:12px;
      backdrop-filter: blur(10px);
    }
    .grid{display:grid;grid-template-columns: 1fr; gap:12px}
    @media(min-width:860px){ .grid{grid-template-columns: 380px 1fr; align-items:start;} }

    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{
      border:1px solid var(--line);
      background: rgba(0,0,0,.15);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:800;
      display:flex;gap:8px;align-items:center;
      user-select:none;
    }
    .btn:hover{border-color:rgba(255,255,255,.22)}
    .btn.active{outline:2px solid rgba(255,255,255,.18); border-color:rgba(255,255,255,.25)}
    .btn:disabled{opacity:.45; cursor:not-allowed}
    .dot{width:10px;height:10px;border-radius:999px;display:inline-block}

    .nav{display:flex;gap:8px;align-items:center}
    .nav button{padding:10px 12px}

    .month{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:10px;
    }
    .dow{font-size:12px;color:var(--muted);text-align:center;padding:6px 0}

    .day{
      border:1px solid var(--line);
      border-radius:14px;
      min-height:86px;
      padding:10px;
      position:relative;
      background: rgba(255,255,255,.035);
      overflow:visible; /* важливо: щоб "змійка" була зовні */
    }
    .day.muted{opacity:.48}

    .dayInner{
      position:relative;
      border-radius:14px;
      overflow:hidden;
      min-height:86px;
      padding:10px;
      background: rgba(255,255,255,.035);
      border:1px solid rgba(255,255,255,.00);
    }

    .day.today .dayInner{
      border:2px solid rgba(255,255,255,.92);
      background: rgba(255,255,255,.06);
    }
    .todayTag{
      position:absolute;right:10px;top:10px;
      font-size:10px;font-weight:900;
      letter-spacing:.08em;
      color:#0b0f14;
      background:#fff;
      padding:2px 8px;border-radius:999px;
      z-index:3;
    }
    .num{font-weight:900;font-size:14px;z-index:2;position:relative}

    /* ===== "ЗМІЙКА" НАВКОЛО КЛІТИНКИ (ЗОВНІ) ===== */
    .snake{
      position:absolute;
      inset:-4px;            /* виходимо назовні */
      border-radius:18px;
      padding:3px;           /* товщина рамки */
      opacity:0;
      pointer-events:none;
      z-index:1;

      /* background задаємо через JS */
      background: conic-gradient(from 0deg, transparent, transparent);

      /* робимо рамку (порожня середина) */
      -webkit-mask:
        linear-gradient(#000 0 0) content-box,
        linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;

      animation: spin 1.5s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .day.hasSnake .snake{opacity:1}

    /* Фолбек (на випадок якщо маска не спрацює): тонка смуга зліва */
    .bar{
      position:absolute; left:-4px; top:-4px; bottom:-4px; width:5px;
      border-radius:12px;
      opacity:0;
      pointer-events:none;
      z-index:1;
      background: transparent;
    }
    .day.hasSnake .bar{opacity:1}

    /* ===== бейджики графіка ===== */
    .badges{
      position:absolute;
      left:10px;
      bottom:10px;
      display:flex;
      gap:6px;
      z-index:3;
    }
    .badge{
      font-size:11px;
      font-weight:950;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.22);
      color: var(--text);
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .badge .miniDot{width:8px;height:8px;border-radius:999px;display:inline-block}

    .hint{font-size:13px;color:var(--muted);line-height:1.45}
    .infoBlock{display:grid;gap:10px;margin-top:12px}
    .infoCard{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
      background:rgba(255,255,255,.03);
    }
    .infoTitle{display:flex;gap:8px;align-items:center;font-weight:950}
    .infoRow{margin-top:6px;font-size:13px;color:var(--text)}
    .infoRow small{color:var(--muted)}
    .warn{
      display:inline-block;
      margin-left:6px;
      font-size:11px;
      font-weight:900;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.18);
      color: var(--muted);
      vertical-align:middle;
    }
    .warn.soon{
      color:#0b0f14;
      background:#fff;
      border-color:#fff;
    }

    /* Перемикач графіків */
    .splitRow{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:10px}
    .select{
      border:1px solid var(--line);
      background: rgba(0,0,0,.15);
      color: var(--text);
      padding:10px 12px;
      border-radius:12px;
      font-weight:800;
      cursor:pointer;
      outline:none;
    }
    .label{font-size:12px;color:var(--muted);margin-top:10px}
  </style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div>
      <h1>Календар змін 2/2 — 3 інженери</h1>
      <div class="sub">
        Обери інженера — побачиш його робочі дні з анімацією <b>«змійка навколо дати»</b>.
        Кнопка <b>«Напарник»</b> додає другого інженера: у спільні робочі дні рамка буде <b>50/50</b> двома кольорами й крутитиметься.
      </div>
    </div>
    <div class="nav">
      <button class="btn" id="prev">← Місяць</button>
      <button class="btn" id="next">Місяць →</button>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="controls" id="primaryBtns"></div>

      <div class="splitRow">
        <button class="btn" id="mateToggle" disabled>Напарник</button>

        <button class="btn" id="showGraphsBtn" disabled>Показувати графіки</button>

        <select class="select" id="graphFilter" disabled>
          <option value="all">Усі</option>
          <option value="358">Лише 358</option>
          <option value="323">Лише 323</option>
          <option value="none">Жодні</option>
        </select>
      </div>

      <div class="controls" id="mateBtns" style="display:none;margin-top:10px"></div>

      <div class="infoBlock" id="info"></div>

      <div style="height:10px"></div>
      <div class="hint" id="hint">
        Порада: якщо нікого не обрано — календар нейтральний. Обери інженера, щоб бачити підсвітку та підказки.
      </div>
    </div>

    <div class="card">
      <div class="sub" id="monthTitle" style="font-size:14px;margin:0 0 10px"></div>
      <div class="month" id="cal"></div>
    </div>
  </div>
</div>

<script>
  // ===================== НАЛАШТУВАННЯ =====================
  const PEOPLE = [
    { id: 1, name: "Інженер 1", color: "var(--c1)" },
    { id: 2, name: "Інженер 2", color: "var(--c2)" },
    { id: 3, name: "Інженер 3", color: "var(--c3)" },
  ];

  // Якір (з твого прикладу): 15–16.01.2026
  const ANCHOR = new Date(2026, 0, 15);

  // Початкові графіки на старті якоря
  const INITIAL_ASSIGNMENT = { 1: "358", 2: "358", 3: "323" };

  // В кінці кожного 2-денного блоку перемикається один інженер: 2 -> 3 -> 1 -> повтор
  const SWITCH_ORDER = [2, 3, 1];

  // ===================== ДАТИ =====================
  function daysBetween(a, b){
    const utcA = Date.UTC(a.getFullYear(), a.getMonth(), a.getDate());
    const utcB = Date.UTC(b.getFullYear(), b.getMonth(), b.getDate());
    return Math.floor((utcB - utcA) / 86400000);
  }
  function addDays(d, n){ return new Date(d.getFullYear(), d.getMonth(), d.getDate() + n); }
  function blockIndexForDate(date){
    const diff = daysBetween(ANCHOR, date);
    return Math.floor(diff / 2);
  }
  function startOfBlock(blockIndex){ return addDays(ANCHOR, blockIndex * 2); }
  function workingGraphForBlock(blockIndex){ return (blockIndex % 2 === 0) ? "358" : "323"; }
  function toggleGraph(g){ return g === "358" ? "323" : "358"; }

  // призначення графіків на початку блоку
  function assignmentAtBlock(targetBlock){
    let a = { ...INITIAL_ASSIGNMENT };
    if (targetBlock === 0) return a;

    if (targetBlock > 0){
      for (let b = 0; b < targetBlock; b++){
        const sw = SWITCH_ORDER[((b % 3) + 3) % 3];
        a[sw] = toggleGraph(a[sw]);
      }
      return a;
    }

    // назад
    for (let b = -1; b >= targetBlock; b--){
      const sw = SWITCH_ORDER[(((b % 3) + 3) % 3)];
      a[sw] = toggleGraph(a[sw]);
    }
    return a;
  }

  function graphOnDate(personId, date){
    const bi = blockIndexForDate(date);
    const a = assignmentAtBlock(bi);
    return a[personId];
  }
  function isWorkingOnDate(personId, date){
    const bi = blockIndexForDate(date);
    return graphOnDate(personId, date) === workingGraphForBlock(bi);
  }

  // наступна дата, коли інженер ПЕРЕЙДЕ на інший графік
  function nextSwitchDate(personId, fromDate){
    const currentBlock = blockIndexForDate(fromDate);
    for (let b = currentBlock; b < currentBlock + 2000; b++){
      const sw = SWITCH_ORDER[(((b % 3) + 3) % 3)];
      if (sw === personId) return startOfBlock(b + 1);
    }
    return null;
  }

  function fmtDateUA(d){
    return d.toLocaleDateString("uk-UA", { day:"2-digit", month:"long", year:"numeric" });
  }
  function fmtMonthUA(d){
    return d.toLocaleDateString("uk-UA", { month:"long", year:"numeric" });
  }

  // ===================== UI СТАН =====================
  let shown = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
  let primary = null;
  let mate = null;
  let mateMode = false;

  let showGraphs = false;
  let graphFilter = "all"; // all | 358 | 323 | none

  const calEl = document.getElementById("cal");
  const monthTitleEl = document.getElementById("monthTitle");
  const primaryBtnsEl = document.getElementById("primaryBtns");
  const mateToggleEl = document.getElementById("mateToggle");
  const mateBtnsEl = document.getElementById("mateBtns");
  const infoEl = document.getElementById("info");
  const hintEl = document.getElementById("hint");
  const showGraphsBtnEl = document.getElementById("showGraphsBtn");
  const graphFilterEl = document.getElementById("graphFilter");

  function personById(id){ return PEOPLE.find(p => p.id === id); }

  function setPrimary(id){
    if (primary === id){
      primary = null;
      mate = null;
      mateMode = false;
      mateToggleEl.classList.remove("active");
      mateBtnsEl.style.display = "none";

      showGraphs = false;
      showGraphsBtnEl.classList.remove("active");
    } else {
      primary = id;
      if (mate === primary) mate = null;
    }
    renderAll();
  }

  function toggleMateMode(){
    if (!primary) return;
    mateMode = !mateMode;
    if (!mateMode) mate = null;
    renderAll();
  }

  function setMate(id){
    if (!primary) return;
    if (id === primary) return;
    mate = (mate === id) ? null : id;
    renderAll();
  }

  function toggleShowGraphs(){
    if (!primary) return;
    showGraphs = !showGraphs;
    showGraphsBtnEl.classList.toggle("active", showGraphs);
    renderAll();
  }

  mateToggleEl.onclick = toggleMateMode;
  showGraphsBtnEl.onclick = toggleShowGraphs;
  graphFilterEl.onchange = (e) => { graphFilter = e.target.value; renderAll(); };

  function renderPrimaryButtons(){
    primaryBtnsEl.innerHTML = "";
    PEOPLE.forEach(p => {
      const btn = document.createElement("button");
      btn.className = "btn" + (primary === p.id ? " active" : "");
      btn.innerHTML = `<span class="dot" style="background:${p.color}"></span>${p.name}`;
      btn.onclick = () => setPrimary(p.id);
      primaryBtnsEl.appendChild(btn);
    });
  }

  function renderMateUI(){
    mateToggleEl.disabled = !primary;
    mateToggleEl.classList.toggle("active", !!primary && mateMode);

    showGraphsBtnEl.disabled = !primary;
    graphFilterEl.disabled = !primary;

    if (!primary || !mateMode){
      mateBtnsEl.style.display = "none";
      mateBtnsEl.innerHTML = "";
      return;
    }

    mateBtnsEl.style.display = "flex";
    mateBtnsEl.style.gap = "10px";
    mateBtnsEl.style.flexWrap = "wrap";

    mateBtnsEl.innerHTML = "";
    PEOPLE.filter(p => p.id !== primary).forEach(p => {
      const btn = document.createElement("button");
      btn.className = "btn" + (mate === p.id ? " active" : "");
      btn.innerHTML = `<span class="dot" style="background:${p.color}"></span>${p.name}`;
      btn.onclick = () => setMate(p.id);
      mateBtnsEl.appendChild(btn);
    });
  }

  // ===== ГРАДІЄНТ РАМКИ =====
  function snakeGradient(color){
    // "змійка": більшість прозора, маленька "голова" + короткий "хвіст"
    // можна підкрутити відсотки під смак
    return `conic-gradient(
      from 0deg,
      transparent 0 72%,
      ${color} 72% 84%,
      rgba(255,255,255,0) 84% 100%
    )`;
  }

  function halfHalfGradient(colorA, colorB){
    // 50/50 півкола двома кольорами
    return `conic-gradient(from 0deg, ${colorA} 0 50%, ${colorB} 50% 100%)`;
  }

  function ringForDay(date){
    // повертає {bg, barColor} або null
    if (!primary) return null;

    const pWork = isWorkingOnDate(primary, date);
    const mWork = mateMode && mate ? isWorkingOnDate(mate, date) : false;

    if (!pWork && !mWork) return null;

    // Якщо обидва працюють — 50/50
    if (mateMode && mate && pWork && mWork){
      const cA = personById(primary).color;
      const cB = personById(mate).color;
      return { bg: halfHalfGradient(cA, cB), barColor: `linear-gradient(180deg, ${cA} 0 50%, ${cB} 50% 100%)` };
    }

    // Інакше — "змійка" кольором того, хто працює
    const who = pWork ? primary : mate;
    const c = personById(who).color;
    return { bg: snakeGradient(c), barColor: c };
  }

  function shouldShowGraphLabel(g){
    if (!showGraphs) return false;
    if (graphFilter === "none") return false;
    if (graphFilter === "all") return true;
    return g === graphFilter;
  }

  function renderInfo(){
    infoEl.innerHTML = "";

    if (!primary){
      infoEl.innerHTML = `
        <div class="infoCard">
          <div class="infoTitle">Підказка</div>
          <div class="infoRow"><small>Оберіть інженера, щоб бачити: графік сьогодні, дату наступного перемикання та скільки днів лишилось.</small></div>
        </div>
      `;
      hintEl.textContent = "Нікого не обрано. Натисни на інженера, щоб увімкнути підсвітку та підказки.";
      return;
    }

    hintEl.textContent = "Обрано інженера. Увімкни «Напарник», щоб додати другого й бачити 50/50 рамку в спільні робочі дні.";

    const today = new Date();
    const selected = [primary];
    if (mateMode && mate) selected.push(mate);

    selected.forEach(id => {
      const p = personById(id);
      const works = isWorkingOnDate(id, today);
      const graphToday = graphOnDate(id, today);

      const ns = nextSwitchDate(id, today);
      const daysLeft = ns ? daysBetween(today, ns) : null;

      const warnClass = (daysLeft !== null && daysLeft <= 2) ? "warn soon" : "warn";
      const warnText = (daysLeft !== null) ? `${daysLeft} дн.` : "—";

      infoEl.insertAdjacentHTML("beforeend", `
        <div class="infoCard">
          <div class="infoTitle">
            <span class="dot" style="background:${p.color}"></span>${p.name}
          </div>
          <div class="infoRow">
            <b>Сьогодні:</b> ${works ? "Працює" : "Вихідний"}
            <span class="${warnClass}">${fmtDateUA(today)}</span>
          </div>
          <div class="infoRow">
            <b>Графік сьогодні:</b> ${graphToday}
          </div>
          <div class="infoRow">
            <b>Наступне перемикання графіка:</b> ${ns ? fmtDateUA(ns) : "—"}
            <span class="${warnClass}">залишилось: ${warnText}</span>
          </div>
        </div>
      `);
    });
  }

  function dayCell(date, muted){
    const el = document.createElement("div");
    el.className = "day" + (muted ? " muted" : "");

    const now = new Date();
    const isToday =
      date.getFullYear()===now.getFullYear() &&
      date.getMonth()===now.getMonth() &&
      date.getDate()===now.getDate();
    if (isToday) el.classList.add("today");

    const ring = ringForDay(date);
    if (ring) el.classList.add("hasSnake");

    // бейджики графіків (тільки якщо увімкнено)
    const badges = [];
    if (primary){
      const g = graphOnDate(primary, date);
      if (shouldShowGraphLabel(g)){
        badges.push({ color: personById(primary).color, text: g });
      }
    }
    if (mateMode && mate){
      const g2 = graphOnDate(mate, date);
      // щоб не було шуму — показуємо тільки якщо в цей день працює напарник (або якщо працює пара 50/50)
      const mateWorks = isWorkingOnDate(mate, date);
      const bothWork = primary && isWorkingOnDate(primary, date) && mateWorks;
      if ((mateWorks || bothWork) && shouldShowGraphLabel(g2)){
        badges.push({ color: personById(mate).color, text: g2 });
      }
    }

    const ringBg = ring ? ring.bg : "conic-gradient(from 0deg, transparent, transparent)";
    const barBg  = ring ? ring.barColor : "transparent";

    el.innerHTML = `
      <div class="snake" style="background:${ringBg}"></div>
      <div class="bar" style="background:${barBg}"></div>
      <div class="dayInner">
        ${isToday ? `<div class="todayTag">СЬОГОДНІ</div>` : ``}
        <div class="num">${date.getDate()}</div>
        ${badges.length ? `
          <div class="badges">
            ${badges.slice(0,2).map(b => `
              <span class="badge">
                <span class="miniDot" style="background:${b.color}"></span>${b.text}
              </span>
            `).join("")}
          </div>
        ` : ``}
      </div>
    `;
    return el;
  }

  function renderCalendar(){
    monthTitleEl.textContent = `Місяць: ${fmtMonthUA(shown)}`;

    calEl.innerHTML = "";
    const dows = ["Пн","Вт","Ср","Чт","Пт","Сб","Нд"];
    dows.forEach(x=>{
      const el = document.createElement("div");
      el.className = "dow";
      el.textContent = x;
      calEl.appendChild(el);
    });

    const y = shown.getFullYear();
    const m = shown.getMonth();

    const first = new Date(y, m, 1);
    const startDow = (first.getDay() + 6) % 7;
    const daysInMonth = new Date(y, m+1, 0).getDate();
    const daysInPrev = new Date(y, m, 0).getDate();

    for(let i=0;i<startDow;i++){
      const d = daysInPrev - startDow + 1 + i;
      calEl.appendChild(dayCell(new Date(y, m-1, d), true));
    }
    for(let d=1; d<=daysInMonth; d++){
      calEl.appendChild(dayCell(new Date(y, m, d), false));
    }
    const totalCells = 7 + startDow + daysInMonth;
    const after = (Math.ceil(totalCells/7)*7) - totalCells;
    for(let i=1;i<=after;i++){
      calEl.appendChild(dayCell(new Date(y, m+1, i), true));
    }
  }

  document.getElementById("prev").onclick = () => {
    shown = new Date(shown.getFullYear(), shown.getMonth()-1, 1);
    renderAll();
  };
  document.getElementById("next").onclick = () => {
    shown = new Date(shown.getFullYear(), shown.getMonth()+1, 1);
    renderAll();
  };

  function renderAll(){
    renderPrimaryButtons();
    renderMateUI();
    renderInfo();
    renderCalendar();
  }

  renderAll();

  // Якщо хочеш, щоб "СЬОГОДНІ" перемикалось в північ без перезавантаження:
  // setInterval(renderAll, 60 * 1000);
</script>
</body>
</html>
